\section{Definitions}
\label{sec:definitions}

\begin{itemize}
\item An \emph{interface} $I$ is a discrete graph.

\item An \emph{open graph} is an arrow $g\of I\to G$ where $I$ is an interface; we say that $g$ has \emph{interface} $I_g=I$ and \emph{pattern} $P_g=G$. Open graphs are used for different purposes: within a condition to associate (both upper and lower) interfaces with the patterns, and also as assignments --- that is, the objects on which satisfaction is defined.

\item An \emph{interface morphism} $f$ from $I$ to $J$ is a graph morphism $k:I\to J$.

\item An \emph{open graph morphism} $a\of g\to h$ a pair of graph morphisms $a^I:I_g\to I_h, a^P:P_g\to P_h$ such that $a^I;h=g;a^P$.
\end{itemize}
%
A \emph{condition tree} is a tuple $(V,E,\setof{d_v}_{v\in V},\setof{u_w}_{(v,w)\in C})$ such that

\begin{itemize}
\item $V$ is a set of vertices;

\item $C\subseteq V\times V$ is a set of edges representing the parent-child relation, such that one $v\in P$ (the \emph{root}) has no outgoing edge, and all other elements of $V$ have exactly one outgoing edge (to their \emph{parent});

\item for all $v\in V$, $d_v$ is an open graph. We denote $I_v=I_{d_v}$ and $P_v=P_{d_v}$.

\item for all $c=(v,w)\in C$, $u_w\of I_w\to P_v$ is an open graph.
\end{itemize}
%
The root of a tree $\cT$ is denoted $\rt\cT$; its \emph{root interface} is $I_\cT=I_{\rt\cT}$. For an arbitrary vertex $v\in V_\cT$, $\hat v$ will denote the subtree rooted at $v$.

\paragraph{Satisfaction.}

Let $\cT$ be a condition tree. Satisfaction is defined for nodes $v\in V_\cT$ and assignments $g\of I^v\to G$, as follows. $g$ \emph{satisfies $v$}, denoted $g\sat v$, if there is a graph morphism $h\of P^v\to g$ such that
\begin{inumerate}
\item $g=d_v;h$, and 
\item $u_w;a_P\nsat w$ for all children $w$ of $v$.
\end{inumerate}
$h$ is then called a \emph{witness} of $g\sat v$.
$g$ satisfies $\cT$, denoted $g\sat\cT$, if $g\sat\rt\cT$.

\paragraph{Morphisms.}

Given two condition trees $\cT,\cU$ with $I_\cT=I_\cU$, a morphism $\cM$ from $\cT$ to $\cU$ is a set of triples $(v,a,w)$ where $(v,w)\in (V_\cT\times V_\cU)\cup (V_\cU\times V_\cT)$ and $a\of d_v\to d_w$ is an open graph morphism, such that $\rt\cM=(\rt\cT,(\id,r),\rt\cU)\in \cM$ for some $r$.

Given a condition tree $\cT$, the identity morphism $\cI_\cT$ is defined as
\[ \cI_\cT = \setof{(v,\id_{d_v},v)\mid v\in V_\cT} \enspace. \]
Given two condition tree moprhisms $\cM\of \cT\to \cU,\cN\of \cU\to \cV$, their composition is defined as
\[ \cM;\cN = \setof{(v,a;b,x) \mid \exists w\st (v,a,w)\in \cM, (w,b,x)\in \cN} \enspace. \]

\begin{proposition}
Condition trees and their morphisms form a category.
\end{proposition}

\paragraph{Source saturation.}

Given a morphism $\cM$, an element $(v,a,w)\in \cM$ is called \emph{source-saturated} if for every child $x$ of $v$, one of the following holds:

\begin{enumerate}[label=(\alph*)]
\item There is a child $y$ of $w$ and a source-saturated $(y,b,x)\in\cM$ such that $b^I;u_x;a^P=u_y$.
\item There is a child $y$ of $x$ and a source-saturated $(y,b,w)\in\cM$ such that, constructing the pullback $(u,d)$ of $(d_x,u_y)$, $d$ is epi and $u;u_x;a^P=d;d_y;b^P$.
\item There is a sibling $y$ of $w$, a source-saturated $(y,b,x)\in\cM$ and an interface morphism $k\of I_y\to I_w$ such that $u_y=k;u_w$ and $b^I;u_x;a^P=k;d_w$.
\end{enumerate}
%
We call $\cM$ source-saturated if $\rt\cM$ is source-saturated.\todo{AR: alternatively, if all elements of $\cM$ are source-saturated}

Vacuously, the condition of source saturation is fulfilled if $v$ does not have children, hence in that case all $(v,x,a)\in \cM$ are source-saturated; this will form the base case of our induction proofs.

The three cases of source saturation are visualised in \cref{fig:source-saturation}.

\begin{figure}
\input{figs/source-saturation}
\caption{The three options for source-saturation}
\label{fig:source-saturation}
\end{figure}

\begin{lemma}[source saturation reflects satisfaction]\label{lem:source-saturation}
Let $\cM\of\cT\to\cU$ be a condition tree morphism. For all source-saturated $(v,a,w)\in \cM$, if $g\sat w$ with witness $h$, then $a^I;g\sat v$ with witness $a^P;h$. It follows that, if $\cM$ is source-saturated, $g\sat\cU$ implies $g\sat\cT$.
\end{lemma}

\paragraph{Target saturation.}

Given a morphism $\cM$, an element $(v,a,w)\in \cM$ is called \emph{target-saturated} if one of the following holds:

\begin{enumerate}[label=(\alph*)]
\item There is a child $x$ of $w$ with $d_x=u_x=d_v$, such that for all children $y$ of $x$ there is a target-saturated $(y,c,w)$
\end{enumerate}

\begin{lemma}[target saturation preserves satisfaction]
Let $\cM\of\cT\to\cU$ be a condition tree morphism. For all target-saturated $(v,a,w)\in \cM$, if $a^;g\sat v$ with witness $h$, then $g\sat w$ with witness $h'$ such that $h=a^P;h'$. It follows that, if $\cM$ is target-saturated, $g\sat\cT$ implies $g\sat\cU$.
\end{lemma}

